{% extends "base.html" %}
{% block title %}Статистика Сайта | ЧС Сосмарка{% endblock %}

{% block head %}
  {{ super() }} {# Include styles from base.html #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script>
    var chartData = JSON.parse('{{ chart_data | tojson | safe }}');
  </script>
  <script src="{{ url_for('static', filename='js/pages/statistics.js') }}" defer></script>
  <style>
    .stat-card {
      background-color: #2a2a2e;
      border: 1px solid #444;
      color: #f1f1f1;
      margin-bottom: 20px;
    }
    .stat-card .card-header {
      background-color: #343a40;
      border-bottom: 1px solid #444;
      font-weight: bold;
    }
    .stat-card .card-title {
      font-size: 2.5rem;
      color: #17a2b8;
    }
    .chart-container {
      background-color: #2a2a2e;
      padding: 20px;
      border-radius: 5px;
      border: 1px solid #444;
      margin-bottom: 30px;
    }
    .chart-container h3 {
        color: #e9ecef;
        margin-bottom: 20px;
    }
    canvas {
        max-width: 100%; /* Ensure canvas is responsive */
    }
    .latest-additions-list .list-group-item {
        background-color: #343a40;
        border-color: #444;
        color: #f1f1f1;
    }
    .latest-additions-list .list-group-item strong {
        color: #17a2b8;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Статистика Сайта</h1>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">На главную</a>
    </div>

    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="card text-center stat-card">
                <div class="card-header">Записей в ЧС</div>
                <div class="card-body"><h2 class="card-title">{{ total_blacklist_entries }}</h2></div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center stat-card">
                <div class="card-header">Уникальных Игроков в ЧС</div>
                <div class="card-body"><h2 class="card-title">{{ unique_players_in_blacklist }}</h2></div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center stat-card">
                <div class="card-header">Всего Проверок</div>
                <div class="card-body"><h2 class="card-title">{{ total_checks }}</h2></div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center stat-card">
                <div class="card-header">Проверок за 24ч</div>
                <div class="card-body"><h2 class="card-title">{{ checks_last_24_hours }}</h2></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="chart-container">
                <h3>Динамика добавления в ЧС (последние 12 месяцев)</h3>
                <canvas id="blacklistGrowthChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h3>Топ 5 Причин Добавления в ЧС</h3>
                <canvas id="topReasonsChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container latest-additions-list">
                <h3>Последние 5 Добавлений в ЧС</h3>
                {% if latest_blacklist_additions %}
                    <ul class="list-group list-group-flush">
                        {% for entry in latest_blacklist_additions %}
                            <li class="list-group-item">
                                <strong>{{ entry.nickname }}</strong> ({{ entry.uuid }})<br>
                                <small>Причина: {{ entry.reason }}</small><br>
                                <small>Дата: {{ entry.created_at | format_datetime }}</small>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Нет недавних добавлений.</p>
                {% endif %}
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %} 