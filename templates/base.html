<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  {# Child templates can override these #}
  {% set page_title = page_title|default("ЧС Сосмарка") %}
  {% set page_description = page_description|default("Проверьте наличие вашего никнейма в черном списке Сосмаркской Империи. Мгновенная проверка и актуальные данные.") %}
  <title>{{ page_title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  
  <!-- Cache Control -->
  <meta http-equiv="Cache-Control" content="max-age=31536000, public">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="{{ page_description }}">
  <meta name="keywords" content="ЧС, черный список, Сосмарк, blacklist, проверка никнейма, minecraft blacklist">
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">
  <meta name="author" content="Сосмарк">
  <link rel="canonical" href="{{ request.url }}" />

  <!-- Open Graph -->
  <meta property="og:site_name" content="ЧС Сосмарка">
  <meta property="og:title" content="{{ page_title }}">
  <meta property="og:description" content="{{ page_description }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:image" content="{{ url_for('static', filename='icons/og-image.png', _external=True) }}">
  <meta property="og:locale" content="ru_RU">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page_title }}">
  <meta name="twitter:description" content="{{ page_description }}">
  <meta name="twitter:image" content="{{ url_for('static', filename='icons/og-image.png', _external=True) }}">

  <!-- PWA & Icons -->
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
  <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/favicon.ico') }}" type="image/x-icon">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

  <!-- Resource Hints -->
  <link rel="preconnect" href="https://minotar.net" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://minotar.net">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  
  <!-- Critical CSS -->
  <style>
    /* Inline critical CSS here */
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    .error-message { padding: 1rem; background: #ff5252; color: white; text-align: center; }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
  </style>
  
  <!-- Deferred CSS -->
  <link rel="preload" href="{{ url_for('static', filename='css/theme.css') }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="{{ url_for('static', filename='css/style.css') }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </noscript>

  <!-- Preload Key Assets -->
  <link rel="preload" href="{{ url_for('static', filename='fonts/Poppins.woff2') }}" as="font" type="font/woff2" crossorigin>
  
  <!-- Core Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  
  <!-- Structured Data -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "ЧС Сосмарка",
      "url": "{{ request.url_root }}",
      "description": "{{ page_description }}",
      "inLanguage": "ru-RU",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "{{ request.url_root }}?nickname={nickname}"
        },
        "query-input": "required name=nickname"
      }
    }
  </script>

  <!-- Service Worker -->
  <script src="{{ url_for('static', filename='js/sw-register.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/confetti.browser.min.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/base.js') }}" defer></script>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  {% block head %}{% endblock %}
</head>
<body>
  <noscript>
    <div class="error-message">Для работы приложения требуется JavaScript</div>
  </noscript>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer" role="alert" aria-live="polite"></div>

  <header role="banner">
    <nav role="navigation" aria-label="Основная навигация">
      <ul>
        <li><a href="{{ url_for('index') }}" {% if request.endpoint == 'index' %}aria-current="page"{% endif %}>Главная</a></li>
        <li><a href="{{ url_for('fullist') }}" {% if request.endpoint == 'fullist' %}aria-current="page"{% endif %}>Полный список</a></li>
        <li><a href="{{ url_for('contacts') }}" {% if request.endpoint == 'contacts' %}aria-current="page"{% endif %}>Контакты</a></li>
      </ul>
    </nav>
  </header>

  <main id="main-content" class="container" role="main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="notification" role="alert">
          {% for category, message in messages %}
            {% if category == 'error' %}
              <div class="error-message">{{ message }}</div>
            {% elif category == 'success' %}
              <div class="success-message">{{ message }}</div>
            {% else %}
              <div class="{{ category }}-message">{{ message }}</div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <footer class="footer mt-auto py-3 bg-light" role="contentinfo">
    <div class="container text-center">
      <span class="text-muted">© {{ current_year() }} Blacklist Sosmark. Все права защищены.</span>
    </div>
  </footer>

  {% block scripts %}{% endblock %}

  <script>
    // Add CSRF token to all forms
    document.addEventListener('DOMContentLoaded', function() {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      document.querySelectorAll('form').forEach(form => {
        if (!form.querySelector('input[name="csrf_token"]')) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrf_token';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
        }
      });
    });
  </script>
</body>
</html>
