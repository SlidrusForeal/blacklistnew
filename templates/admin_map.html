{% extends "base.html" %}

{% set page_title = "Карта игроков | ЧС Сосмарка" %}
{% set page_description = "Интерактивная карта игроков с модом NoSos" %}

{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-map.css') }}">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  {# Import Supabase JS library - make sure this matches your setup #}
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="{{ url_for('static', filename='js/supabase-init.js') }}"></script>
  <script src="{{ url_for('static', filename='js/api-config.js') }}"></script>
  <script>
    // Initialize Supabase using the API
    initializeSupabaseFromApi().catch(error => {
      console.error('Failed to initialize Supabase:', error);
    });
  </script>
  <script src="{{ url_for('static', filename='js/pages/admin-map.js') }}" defer></script>
  <style>
    #activityMap {
      height: 600px; /* Adjust as needed */
      width: 100%;
      border: 1px solid #555;
      border-radius: 5px;
      margin-top: 10px; /* Reduced margin */
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
        background-color: #3a3a3a; /* Dark background for popups */
        color: #f1f1f1; /* Light text for popups */
        box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content {
        color: #f1f1f1; /* Ensure text inside content is light */
    }
    .leaflet-popup-close-button {
        color: #f1f1f1 !important; /* Make close button visible */
    }
    .leaflet-container {
        background: #2c2c2c; /* Dark background for the map tiles area */
    }
    .map-controls {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .player-list-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #444;
        padding: 10px;
        border-radius: 4px;
        background-color: #2c2c2c;
        margin-top: 10px;
    }
    .player-item {
        padding: 8px;
        border-bottom: 1px solid #3a3a3a;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .player-item:last-child {
        border-bottom: none;
    }
    .player-item:hover {
        background-color: #38414a;
    }
    .player-avatar {
        width: 24px;
        height: 24px;
        border-radius: 3px;
        object-fit: cover;
    }
    .player-info {
        flex-grow: 1;
    }
    .player-nickname {
        font-weight: bold;
    }
    .player-coords {
        font-size: 0.85em;
        color: #bbb;
    }
  </style>
{% endblock %}

{% block content %}
<main class="container admin-container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Карта активностей</h1>
    <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">&larr; Назад в админ панель</a>
  </div>
  
  <section class="admin-section">
    <div class="map-controls">
      <button id="toggleHeatmap" class="btn btn-sm btn-info">Тепловая карта (Вкл)</button>
      <button id="toggleGrid" class="btn btn-sm btn-info">Сетка чанков (Вкл)</button>
      <button id="centerMap" class="btn btn-sm btn-primary">Центрировать</button>
    </div>
    <p>На этой карте отображаются последние известные местоположения пользователей (за последний час). Данные обновляются в реальном времени.</p>
    <div id="activityMap"></div>

    <h3 class="mt-4">Активные игроки (последний час):</h3>
    <div id="player-list-container" class="player-list-container">
      <ul id="player-list" class="list-unstyled mb-0">
        <li id="no-players-message">Загрузка игроков...</li>
      </ul>
  </div>
  </section>
</main>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}